---
layout: post
title: "曲谱弹奏模式之自由模式"
summary: 整理自由模式的特色以及评价系统
featured-img: emile-perron-190221
---
### 特色

- 弹奏的首个音符永远不会出现节奏不标准的情况

- 当按下音符数量等于当前事件音符数量时，无论对错，都可进入下一个事件

- 中途可以暂停，下次继续弹奏时，只有第一个音符的评价会出现节奏过晚的情况，其他音符根据用户实际弹奏来获得准确评价。点击一下需要继续弹奏的首个音符即可避免首个音符节奏评价不准确的情况出现

- 智能纠错
- 原理
从单个事件中所有按下的错误的键中，识别出这些错误按键是否是用户在弹奏相邻事件的音符，如果是，就将当前事件更改为用户在弹奏的那个事件

- 条件限制
1. 必须是当前事件中错误按键的数量等于前一个事件或者后一个事件的所有音符数量
2. 错误按键必须大于等于2个
3. 不能同时满足前一个事件和后一个事件


### 评价系统
- 节奏评价

```swift
float interval = touchDownTime-lastTouchDownTime;
float standInterval = note.event.position-lastEventPosition;
float delta = fab(interval - standInterval)
if delta <= fault-tolerant + offsetTime {
note.downRightLevel = GKNoteTapRightNormal;
}else {
if (note.downTime > note.event.position) {
note.downRightLevel = GKNoteTapRightMore;
} else {
note.downRightLevel = GKNoteTapRightLess;
}
}

note.scoreOfTapRight = 100-(int)(fabs(note.downTime-(note.event.position+OffsetTime))/RongCuoTime*40);
if (note.scoreOfTapRight < 40) {
note.scoreOfTapRight = 40;
}
```

> 此算法只能判断前后两个音符按下时间间隔长短的准确与否，不能判断音符弹奏时间和标准弹奏时间的一致性

![自由模式下节奏算法举例1.png](https://upload-images.jianshu.io/upload_images/1368807-b887670f34776491.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![自由模式下节奏算法举例2.png](https://upload-images.jianshu.io/upload_images/1368807-1c0759f4052671fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

- 时值评价

```swift
if (duration > self.duration && duration/self.duration>1.4) {
self.upRightLevel = GKNoteTapRightMore;
if (self.downRightLevel == GKNoteTapRightNormal) {
self.element.stateLayer.fillColor = [UIColor grayColor].CGColor;
}
} else if (duration < self.duration && duration/self.duration<0.3) {
self.upRightLevel = GKNoteTapRightLess;
if (self.downRightLevel == GKNoteTapRightNormal) {
self.element.stateLayer.fillColor = [UIColor grayColor].CGColor;
}
} else {
self.upRightLevel = GKNoteTapRightNormal;
}
if (duration > self.duration) {
self.scoreOfTapTime = 100-(duration-self.duration)/self.duration/4*200;
} else {
self.scoreOfTapTime = 100 - (self.duration-duration)/self.duration/7*200;
}
if (self.scoreOfTapTime < 40) {
self.scoreOfTapTime = 40;
}
```

- 力度评价

```swift
if (_downDynamics-[self.dynamics integerValue] > 30) {
self.midiStrongRightLevel = GKNoteTapRightMore;
} else if ([self.dynamics integerValue]-_downDynamics > 30) {
self.midiStrongRightLevel = GKNoteTapRightLess;
} else {
self.midiStrongRightLevel = GKNoteTapRightNormal;
}
long offset = labs(_downDynamics-[self.dynamics integerValue]);
self.scoreOfTapStrong = 100-offset>0?100-offset:0;
if (self.scoreOfTapStrong == 30 || _downDynamics == -1) {
NSLog(@"downDynamics  %ld",(long)_downDynamics);
}
```
