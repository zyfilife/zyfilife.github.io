---
layout: post
title: "曲谱弹奏模式之跟曲模式"
summary: 整理跟曲模式的特色、业务流程以及评价系统
featured-img: emile-perron-190221
---
### 特色

### 业务流程

- 切换到跟曲模式
    - 数据重置
    - 界面重置
    - 播放按钮切换到普通状态
- 点击播放按钮
    - 重置音符和索引
    - 播放按钮切换到选中状态
    - 开启录制功能
    - 添加倒计时视图，进入倒计时模式
    - 倒计时结束后移除倒计时视图
    - 根据是否开启伴奏开关初始化对应音频文件的播放器，从起始时刻开始播放
- 曲谱播放计时器开始计时
    - 处理超时未弹奏对的音符
    - 处理节拍
    - 根据播放时间轴判断是否结束弹奏
        - 回到循环A
        - 结束弹奏
    - 根据播放时间轴刷新界面和数据
        - 判断光标是否需要消失
        - 判断键盘上的提示是否需要消失
        - 判断灯带上的提示是否需要消失
        - 判断当前要弹奏的事件是否需要切换
            - 回到循环A
            - 进入下一个事件
                - 显示光标
                - 显示键盘上的提示
                - 显示灯带上的提示

### 评价系统

- 节奏评价

    ![跟曲模式节奏评价](/assets/img/posts/曲谱弹奏模式之跟曲模式/跟曲模式节奏评价.png)

    对于按错的或者误差在容错范围之外的音符，不做处理，在超时之后一并作为按错处理
    
- 时值评价

    ![自由模式时值算法代码](/assets/img/posts/曲谱弹奏模式之自由模式/QQ20180315-114153.png)
    
    跟曲模式的时值计算只针对按对的音符
    
- 力度评价

    ![自由模式力度评价](/assets/img/posts/曲谱弹奏模式之自由模式/QQ20180315-114431.png)
